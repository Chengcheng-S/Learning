# Near 分片

分片的类型：

- **网络分片**：将整个区块链网络进行分组，每个小组叫做一个分片(shard)，所有分片处理不同的交易，实现并行记账，或称为物理分片
- **交易分片**：将交易随机分到不同的分片或小组，让某些节点进行记账，如可以通过交易Hash或地址分配，也可以通过VRF 等随机方式进行分配。
- **状态分片**：把完整的账本信息存储在各个分片中，每个分片内各自维护部分的账本信息。

### Near 分片



Near 将区块分为一个个物理组成块，因为每一个区块都包含这些物理组成块，经过对多个区块的验证，物理组成块均相同的时候就可以验证这些区块是正确的。每个区块逻辑上包含所有分片的所有交易，并切分分片的状态，验证者只负责验证交易所针对分片相对应的状态即可。







#### 跨分片交易

Nightshade 采用收据交易的形式，发起跨链交易时首先在一个分片上执行交易，这个交易随后被打包在分片的chunk里，当chunk呗打包到区块中，会形成一个交易收据。 验证者将这个收据交易发送到下一个需要更新的分片上执行。如果这笔交易需要更新更多的分片上的状态，则会重复以上过程。

使用该方案可能会导致某个分片成为热点，一旦大量的交易需要发送到某个分片上时，导致分片的处理能力下降。为解决这个问题Nightshade**在chunk中记录最后处理的跨链交易的进度**。下个块的chunk会按照上一个块的chunk处理进度进行处理，若处理的交易太多超过规定的额阈值，系统会禁止再发送新的跨链交易。



#### 状态验证

Nightshade在BFT共识之上增加了挑战机制来提升安全性。任何的参与者检测到一个chunk包含非法状态时，都可以提供一个证明对chunk的出块者进行惩罚，同时获取奖励。

Nightshade要求在chunk中保存每一个交易执行后分片状态的merkle root，这样挑战者只需要找到第一个非法的状态，并从前一个状态进行验证就可以证明chunk是非法的。



隐藏具体的验证者降低验证者作恶

隐藏验证者的方式：

- 在每个epoch(1/2天)开始时，验证者使用VRF 确定被分配到的分片，并在epoch中负责验证这些分片。
- 所有的验证者都在区块上签名，并不是在chunk上签名。



“隐藏验证者”是从通用验证者池中选出的验证者，被分配去验证除他们自己之外的任何一方都不知道的分片

“渔民”正在观察未经许可检测和报告不良行为的节点。这些节点与网络同步，但不一定参与共识，并且实际上不会因任何特定的持续活动而获得报酬。





### 数据可见性

- 现在的链：所有的节点下载和验证所有的交易  效率十分低
- 未来的链：只需要下载和验证少数的交易

Nightshade中引入纠删码，允许节点在一部分数据不可见时仍能恢复整个区块。

chunk的出块者把纠删码分割成W份（系统中的出块者），并使用merkle tree 计算每一个碎片，然后把merkle root 保存在chunk header中

出块这随后通过onepart消息，把纠删码按照每人一份发送给所有的出块者，消息包含：

- chunk header
- 纠删码编号
- 纠删码碎片内容
- 纠删码merkle proof 
- 出块者的签名

当主链的出块者收到块时，会检查是否已经收到了块中所有chunks的onepart消息，**如果没有则需要等待全部消息接受完成后再继续处理。**

等到主链出块者确定每个chunks都收到了对应的onepart消息之后，就会向peers请求每个chunks其余的纠删码碎片，并重新构建chunk。

如果出块者无法成功构建chunks, 或者无法获取某个chunk的onepart消息的话，就会停止处理该块。





chunk出块者需要对每个纠删码碎片分配颜色（红色或蓝色），并且将颜色保存为bitmask与chunk的内容一起编码成纠删码。

当chunk出块者发送onepart消息时同时也会附上碎片的颜色，并且擦除码碎片的merkle root也会同颜色一起计算。

主链出块者对块签名时，需要在签名中包含所有红色的chunks碎片组成的bitmask。

因为完整的bitmask只存在于纠删码中，**主链的出块者只有通过纠删码重新构造chunk内容和bitmask才能获取正确的颜色。**

主链出块者必须确保自己接收到了所有的onepart消息，且能正确构造所有chunks内容，才可以确保签名是正确的。

若是出块者没有收到某个onepart消息仍然签名，则有概率去猜测颜色而受到惩罚。



