## 二进制格式

### 结构

看rust一段代码：

```shell
cargo new name --lib
```

`cargo.toml` 配置

```toml
[lib]
crate-type=["cdylib"]
```



```rust
extern "C" {fn random_i32()->i32;}
#[no_mangle]
pub extern "C" fn discard (){
    unsafe {let _=random_i32();}
}
```

将这段源码编译之后

```shell
cargo build -target wasm32-unknown-unknown --release
```

接着执行

```shell
wasm-objdump -x name.wasm


...
Section Details:

Type[2]:
 - type[0] () -> i32
 - type[1] () -> nil
Import[1]:
 - func[0] sig=0 <random_i32> <- env.random_i32
Function[1]:
 - func[1] sig=1 <discard>
Table[1]:
 - table[0] type=funcref initial=1 max=1
Memory[1]:
 - memory[0] pages: initial=16
Global[3]:
 - global[0] i32 mutable=1 <__stack_pointer> - init i32=1048576
 - global[1] i32 mutable=0 <__data_end> - init i32=1048576
 - global[2] i32 mutable=0 <__heap_base> - init i32=1048576
Export[4]:
 - memory[0] -> "memory"
 - func[1] <discard> -> "discard"
 - global[1] -> "__data_end"
 - global[2] -> "__heap_base"
Code[1]:
 - func[1] size=9 <discard>
 ...
```

从上述二进制文件的简略信息中可以看出，该文件的组成部分：`Type` `Import` `Function` `Table` `Memory` `Global` `Export` `Code`,这些都是wasm 二进制文件的项目中的一部分。

wasm规范一共定义了12个段，每个段都分配了ID(0--11)

完整的wasm二进制文件的项目划分见下表：

| magic number  version | 以魔数和版本号开头                                           |
| --------------------- | ------------------------------------------------------------ |
|                       | 自定义段 ID 0 这段是给编译器工具使用的，可以存放函数名等调试信息，或其他附加信息。 |
| TypeSec               | 类型段 ID 1  本例中为`Type[2]` random_i32()->i32             |
| ImprotSec             | 导入段 ID 2  本例中为`Import[1]  ` <random_i32> <- env.random_i32 |
| FuncSec               | 函数段 ID 3  本例中为 `Func[1]` discard                      |
| TableSec              | 表段 ID 4   本例中为`type=funcref initial=1 max=1` 列出了模块内定义定义的所有的表，wasm规定最多只能导入和定义一张表 |
| MemroySec             | 内存段 ID 5 本例中为`pages: initial=16`列出模块定义需要的内存空间 |
| GlobalSec             | 全局段 ID 6 本例中为`Global[3]:` 包含模块内定义的全局变量信息，包含值类型、可变性、初始值。 |
| ExportSec             | 导出段  ID 7 本例中`Export[4]:` discard 方法， 至于memory等则是rust 内部实现的。 |
| StartSec              | 起始段 ID 8  给出模块起始函数索引，不同于其他的段，该段只能有一个项目，主要功能：1）在模块加载后进行一些初始化的工作 2） 将模块变成可执行模块。 |
| ElEMSec               | 元素段 ID 9  对应Table elem 表示表内初始化的数据             |
| CodeSec               | 代码段 ID 10 本例中为`func[1] size=9 <discard>`  存储内部函数局部变量的信息和字节码，与函数段一一对应 |
| DataSec               | 数据段 ID 11 列出内存初始化的数据。                          |



### 实体类型

#### 值类型

wasm定义了四种基本的数值类型 32位整数、64位整数、32位浮点数、64位浮点数。高级语言所支持的类型，如布尔类型、指针、结构体等，都是被编译器翻译成这四种基础的值类型。，不同于高级语言，wasm值类型并不会区分符号

#### 函数类型

即函数的签名，描述函数的参数数量和类型，以及返回值和类型

#### 限制类型

描述表元素的数量和内存页数的上下限

#### 内存类型

描述内存的页数限制

#### 表类型

表的元素类型以及元素限制

#### 全局变量

描述全局变量的类型和可变性

#### 结果类型

函数或表达式的执行结果

#### 导出类型

函数类型、表类型、内存类型和全局变量类型的集合

 

### 指令集

和汇编代码一样，wasm二进制模块中的代码也是由多条的指令构成。

wasm的指令包含两部分的信息：操作码和操作数。操作码是指指令的ID，决定指令将执行的操作；操作数相当于指令的参数，决定指令的执行结果。

操作数又分为：

- 静态操作数：直接编码在指令里边，跟在操作码后边
- 动态操作数：在运行时从操作数栈获取

#### 操作码

wasm的操作码固定一个字节，因此指令集最多有256条指令。wasm规范一共定义了178条指，按照功能可以分为5大类：

1. 控制指令：共13条
2. 参数指令： 共2条
3. 变量指令：共5条
4. 内存指令：共25条
5. 数值指令：共133条

























































