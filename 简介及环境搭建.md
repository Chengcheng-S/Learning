## 简介

webassembly/wasm 一个可移植、体积小、加载快并且兼容web的全新格式。 

> Tip：
>
> 在计算机发展早期，程序都是使用机器语言编写，性能方面虽然达到了极致，但是开发效率相对低下，随着技术的发展出现了汇编语言、C、C++，以及后续的java、python（语言越高级，开发效率虽然提升性能却下降，各有取舍。）
>
> 不论技术如何发展计算机唯一能够执行的还是机器语言。所以现代的高级编程语言要么是由编译器编译为机器代码（AOT  Ahead-of-time 预先编译），要么是由解释器直接解释执行（JIT just-in-time 即时编译）
>
> 现代的编译器大多数情况下则是按照模块化的方式设计与实现。典型的做法就是把编译器分为前端、中端、后端。
>
> - 前端：预处理、词法分析、语法分析、语义分析，生成便于后续处理的中间表示（IR ）
> - 中端：对IR进行分析和各种优化，如常量折叠、死代码消除、函数内联。
> - 后端：生成目标代码，把IR转换成与平台相关的汇编代码，最终由汇编器编译为机器代码。

- **高效**：webassembly有一套完整的语义，wasm是体积小且加载快的二进制格式，目标则是充分发挥硬件能力，达到原生执行效率。
- **安全**：webassembly 运行在一个沙箱化的执行环境中，甚至可以在现有的js vm中实现，不仅可以运行在浏览器中，也可以运行在非web环境中。
- **开放**：其设计了一个十分规整的文本格式用来调试、测试、编写程序等，以这种文本格式在web界面上查看wasm模块的源码。
- **不破坏网络**：wasm的设计原则是与其他网络技术和谐共处并保持向后兼容。

### 相关概念：

- **模块**：模块是wasm程序编译、传输和加载的单位，wasm规范定义了两种模块格式：二进制格式和文本格式。
  - 二进制格式：是wasm模块的主要编码格式，后缀为`.wasm` （可以通过高级语言编译，也可以通过wat编译生成）
  - 文本格式： 一般以`.wat` 为后缀，这种格式的文件开发者阅读代码。
  - 内存格式（特例）：wasm的实现通常会把二进制模块解码为内部形式（即内存格式），然后进行处理。
- **内存**：本质上是连续的字节数据，wasm的低级内存存取指令可以对其进行读写操作。
- **表格**：带类型的数组，大小可变。**表格中的存储项不能作为原始字节存储在内存里的对象的引用**
- **实例**：一个模块及其在运行时使用的所有状态，包括内存、表格和一系列导入值。
- **指令集**：类似于jvm，wasm采用了栈式虚拟机和字节码。
- 从语义上讲wasm二进制格式到最终被执行分为三个步骤：
  - 解码：将二进制模块解码为内存格式
  - 验证：对模块进行静态分析，确保模块的结构满足规范要求，且函数字节码不存在违规行为（如不可调用等）
  - 执行：又可以分为实例化和函数调用
  - `.wat`----编译---> `.wasm` --解码 --> `in memeory` -- 实例化-->`instance`




工具安装

默认都装有rust，golang

wabt [WebAssembly/wabt: The WebAssembly Binary Toolkit (github.com)](https://github.com/WebAssembly/wabt)

编译可以参照git上的提示。

需要配置到环境变量中的工具：

- wat2wasm  读取wasm文本格式的文件，检查错误，并将其转化为wasm二进制格式。
  - wat2wasm  test.wat 解析并对xx.wat 文件进行类型检查（.wat文件则是wasm的文本格式，此处只是个例，并无其他意义）
  - wat2wasm test.wat -o test.wasm  解析wat文件并将其输出为 test.wasm 二进制文件。
  - wat2wasm name.wat -v  解析name.wat 并将结果详细输出到终端。
- wasm-strip 裁剪wasm文件
  - wasm-strip name.wasm
- wasm-objdump 打印有关wasm二进制文件内容的信息
  - wasm-objdump test.wasm
    - -d   wasm-objdump -d test.wasm  拆解函数体
    - -x   wasm-objdump -x test.wasm  显示部分详细信息
    - -h   wasm-objdump -h test.wasm  显示头部信息
- wasm2wat  读取webassembly 的二进制格式文件，并将其转换为webassembly 文本格式 即  xx.wasm ===> xx.wat
  - wasm2wat test.wasm -o test.wat 
  - wasm2wat test.wasm --no-debug -o test.wat   无debug信息
  - wasm2wat test.wasm --fold-exprs -o test.wat  尽可能的折叠表达式

其他的工具根据业务需求自行配置，不再赘述。

